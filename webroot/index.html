<html><head>
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
</head>
<body onload="run(5)">
    <!-- <script type="text/javascript" src="jquery-2.2.3.min.js"></script> -->
    <div id="titleContainer">
        <div id="title"></div>
        <nav id="rest"></nav>
        <div id="clear"></div>
    </div>
    <div id="mainContainer">
        <section id="left"><div id="container"></div></section>
        <section id="log"></section>
    </div>
    <footer id="footer">0 e/s</footer>
    <script type="text/javascript">
        let documentationModeIterator = 0
        const uiActionQueue = []
        const state = {}
        let rateCalculationCache = []

        const _ = a => document.querySelector(a)

        // http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
        const getParameterByName = (name, url) => {
            if (!url) url = window.location.href;
            url = url.toLowerCase(); // This is just to avoid case sensitiveness
            name = name.replace(/[\[\]]/g, "\\$&").toLowerCase();// This is just to avoid case sensitiveness for query parameter name
            const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        const init = (configFile) => {
            if (!_(`init_script_${configFile}`)) {
                const element = document.createElement('script')
                element.setAttribute('id', `init_script_${configFile}`)
                element.setAttribute('src', configFile + '.js')
                element.setAttribute('async', false)
                document.head.appendChild(element)
            }
        }

        const log = (message, _color) => {
            const colors = {
                'severe':'#E53A40',
                'error': '#E53A40',
                'warning': '#FFBC42',
                'info': 'inherit',
                'trace': '#6E7783',
                'debug': '#6E7783',
                'happy': '#2f751b',
                'default': 'inherit'
            }

            const color = colors[_color] || colors['default']

            const element = document.createElement('span')
            element.className = 'logLine'
            element.style.color = color
            element.innerHTML = message
            _('#log').insertBefore(element, _('#log').firstChild)

            if (_('#log').children.length > 1000) {
                _('#log').removeChild(_('#log').lastElementChild)
            }
        }

        const run = (timeout) => {
            if (typeof config !== 'undefined')
                doRun()
            else if (timeout > 0) {
                console.log("not ready; retrying...")
                window.setTimeout(() => run(timeout - 1), 50)
            } else {
                log('Did you add .js to it? (you shouldn\'t)', 'error')
                log('Is the ?config=xxx filename wrong?', 'error')
                log('Did you break the JSON syntax?', 'error')
                log('Cannot load configuration file', 'error')
                _('#title').innerHTML = 'Flowbro is drunk :('
            }
        }

        const doRun = () => {
            _('#title').innerHTML = config.title
            loadComponents(config)

            window.setInterval(() => {
                if (uiActionQueue.length > 0) {
                    const event = uiActionQueue.shift()
                    animateFromTo(_(`[id='component_${event.sourceId}']`), _(`[id='component_${event.targetId}']`), event.quantity ? event.quantity : 1)
                }
            }, config.eventSeparationIntervalMilliseconds)

            if (config.rateCalculationEnabled && !config.documentationMode) {
                _('#footer').style.display = 'block';

                window.setInterval(() => {
                    _('#footer').innerHTML = calculateRate(rateCalculationCache) + " e/s"
                    rateCalculationCache = []
                }, config.rateCalculationIntervalMilliseconds)
            }

            if (!config.documentationMode) {
                openWebSocket()
            } else {
                _('#rest').innerHTML = '<button onclick="javascript:resetDocumentationMode()">Reset</button><button onclick="javascript:mockPoll()">Next</button>'
            }
        }

        const openWebSocket = () => {
            const wsUrl = "ws://" + config.webSocketHost + ":" + config.webSocketPort + "/ws"
            const ws = new WebSocket(wsUrl)

            ws.onopen = (event) => {
                log(`WebSocket open on [${wsUrl}]!`, 'happy')
                try {
                    ws.send(JSON.stringify(config.serverConfig))
                    log("Sent configurations to server successfully!", 'happy')
                } catch(e) {
                    log("Server is drunk :( can't send him configurations!", 'error')
                    console.log(e)
                }
            }

            ws.onmessage = (event) => {
                consumedMessages = []
                if (event.data.trim()) {
                    lines = cleanArray(event.data.trim().split(/\n/))
                    for (i in lines) {
                        try {
                            maybeResult = JSON.parse(lines[i])

                            if (config.rateCalculationEnabled && maybeResult.consumedUnixTimestamp) {
                                rateCalculationCache.push(parseInt(maybeResult.consumedUnixTimestamp))
                            }

                            consumedMessages.push(maybeResult)
                        } catch (e) {
                            console.log(`Couldn't parse this as JSON: ${lines[i]}`, "\nError: ", e)
                        }
                    }
                }

                processUiEvents(consumedMessagesToEvents(consumedMessages))
            }

            ws.onclose = (event) => log("WebSocket closed!", 'error')
            ws.onerror = (event) => log(`WebSocket had error! ${event}`, 'error')
        }

        const processUiEvents = (events) => {
            for (let i in events) {
                let event = events[i]

                if (event.eventType == 'streamMessage') {
                    let lastId = uiActionQueue.length - 1
                    let lastUiElement = uiActionQueue[lastId]

                    if (lastUiElement && lastUiElement.sourceId == event.sourceId && lastUiElement.targetId == event.targetId) {
                        uiActionQueue[lastId].quantity = uiActionQueue[lastId].quantity ? uiActionQueue[lastId].quantity + 1 : 2
                    } else {
                        uiActionQueue.push(event)
                    }
                } else if (event.eventType == 'log' && event.text) {
                    log(event.text, event.color)
                }
            }
        }

        const resetDocumentationMode = () => { documentationModeIterator = 0; _('#log').innerHTML = ''; }

        const mockPoll = () => {
            newEvents = config.documentationSteps[documentationModeIterator] ? config.documentationSteps[documentationModeIterator++] : []
            processUiEvents(consumedMessagesToEvents(newEvents))
        }

        const consumedMessagesToEvents = (consumedMessages) => {
            const events = []
            for (let i in consumedMessages) {
                if (consumedMessages[i]) {
                    const newEvents = config.logic(consumedMessages[i], log, state)
                    if (newEvents.length == 0) {
                        log(`Ignoring event: ${consumedMessages[i].value}`, 'debug')
                    }
                    for (let j in newEvents)
                        events.push(newEvents[j])
                }
            }
            return events
        }

        function* colorGenerator() {
            let i = 0
            while(true) {
                i = i >= config.colourPalette.length - 1 ? 0 : i + 1
                yield config.colourPalette[i]
            }
        }

        const loadComponents = (config) => {
            let colorRing = colorGenerator()
            for (let i in config.components) {
                const component = config.components[i]

                let element = document.createElement('div')
                element.id = `component_${component.id}`
                element.className = 'detached component'

                _('#container').appendChild(element)

                if (component.backgroundColor) {
                    element.style.backgroundColor = component.backgroundColor
                }

                element.style.width = component.width ? component.width : "150px"
                element.style.height = component.height ? component.height : "100px"

                const position = componentPosition(config.components, i)
                element.style.left = position.left
                element.style.top = position.top

                if (component.img) {
                    const img = document.createElement('img')
                    img.src = config.images[component.img]
                    element.appendChild(img)
                } else {
                    const title = document.createElement('span')
                    title.className = 'component_title'
                    title.innerHTML = component.id
                    element.appendChild(title)
                    element.style.backgroundColor = component.backgroundColor ? component.backgroundColor : colorRing.next().value
                    title.style.marginTop = "-" + (parseInt(title.offsetHeight) / 2) + "px"
                    title.style.width = parseInt(element.style.width) - 20 - 2 // 20 = padding
                    element.style.boxShadow = "0 2px 5px rgba(0,0,0,0.26)"
                    element.style.textTransform = "uppercase"
                }
            }
        }

        const animateFromTo = (source, target, quantity) => {
            const element = document.createElement('div')
            element.id = guid()
            element.className = 'detached message'

            _('#container').appendChild(element)
            element.style.top = parseInt(source.offsetTop) + (parseInt(source.offsetHeight) / 2) - (parseInt(element.offsetHeight) / 2)
            element.style.left = parseInt(source.offsetLeft) + (parseInt(source.offsetWidth) / 2) - (parseInt(element.offsetWidth) / 2)

            element.style.zIndex = -1

            if (quantity > 1) {
                const q = document.createElement('h2')
                q.innerHTML = quantity
                element.appendChild(q)

                const notRed = quantity * 4 >= 200 ? 55 : 255 - quantity
                const rgb = `rgba(255, ${notRed}, ${notRed}, 0.6)`
                element.style.background = `linear-gradient(${rgb}, ${rgb}), url(images/message.gif)`
            } else {
                element.style.background = 'url(images/message.gif)'
            }
            element.style.backgroundSize = 'cover'

            const newTop = target.offsetHeight / 2 - parseInt(element.offsetHeight) / 2 + parseInt(target.offsetTop)
            const newLeft = target.offsetWidth / 2 - parseInt(element.offsetWidth) / 2 + parseInt(target.offsetLeft)

            style = document.createElement('style')
            style.type = 'text/css'
            const styleId = `style_${guid()}`
            const length = config.animationLengthMilliseconds
            style.appendChild(document.createTextNode(`.${styleId} { top: ${newTop}px !important; left: ${newLeft}px !important; -webkit-transition: top${length}ms, left ${length}ms; /* Safari */ transition: top ${length}ms, left ${length}ms;}`))
            document.body.appendChild(style)

            element.className = `${styleId} detached message`

            const removeNodes = (element, style) => () => {
                element.parentNode.removeChild(element)
                style.parentNode.removeChild(style)
            }

            window.setTimeout(removeNodes(element, style), length)
        }

        const calculateRate = (rateCalculationCache) => {
            rateCalculationCache.sort()
            const first = rateCalculationCache.shift()
            const last = rateCalculationCache.pop()
            const size = rateCalculationCache.length

            return size < 2 ? size : parseInt(size / (last - first + 1))
        }

        const s4 = () => Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1)
        const guid = () => s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4()
        const cleanArray = (actual) => actual.filter((elem) => Boolean(elem))

        const componentPosition = (components, i) => {
            const defaultPositions = [
                [],
                [{left: 50, top: 50}],
                [{left: 50, top: 50}, {left: 450, top: 450}],
                [{left: 50, top: 50}, {left: 50, top: 450}, {left: 450, top: 450}],
                [{left: 50, top: 50}, {left: 50, top: 450}, {left: 450, top: 50}, {left: 450, top: 450}],
                [{left: 50, top: 250}, {left: 200, top: 50}, {left: 100, top: 450}, {left: 450, top: 220}, {left: 450, top: 450}],
            ]

            const position = {}

            if (components[i].top != undefined) {
                position.top = components[i].top
            } else if (defaultPositions[components.length] != undefined) {
                position.top = defaultPositions[components.length][i].top
            } else {
                position.top = 0
            }

            if (components[i].left != undefined) {
                position.left = components[i].left
            } else if (defaultPositions[components.length] != undefined) {
                position.left = defaultPositions[components.length][i].left
            } else {
                position.left = 0
            }

            return position
        }

        init(getParameterByName('config') || 'config-example')
    </script>
    <style>
        body {
            background-color: #FFF;
            margin: 0;
            padding: 0;
            line-height: 1;
            font-family: 'Open Sans', 'Verdana', 'sans-serif';
            color: white;
        }
        b {
            font-weight: bolder;
            font-size: 18px;
        }
        #titleContainer {
            width: 100%;

            font-size: 26px;
            background-color: #0091EA;
        }
        #title {
            padding: 20px;
            float: left;
        }
        #rest {
            overflow: auto;
            padding: 20px;
            text-align: right;
        }
        #clear {
            clear: both;
        }
        #mainContainer {
            color: black;
        }
        .detached {
            position: absolute;
        }
        .message {
            width: 50px;
            height: 38px;
        }

        .component {
            border-radius: 15px;
            text-align: center;
            position: absolute;
        }
        .component img, .message img {
            max-width:100%;
            max-height:100%;
        }
        .component_title {
            padding: 10px;
            text-shadow: 1px 1px 1px gray;
            display: block;
            position: absolute;
            top:50%;
        }
        #left {
            z-index: -2;

            min-width: 700px;
            min-height: 100vh;

            overflow: hidden;
            float: left;

            background-color: transparent;
            box-shadow: inset -3px 3px 3px 1px rgba(0,0,0,0.3);
        }
        #container {
            position: absolute;
        }
        #log {
            overflow: hidden;
            min-height: 100vh;
            background-color: #E0E0E0;
        }
        .logline {
            padding: 10px 15px 5px 15px;
            display: block;
        }
        button {
            margin-right: 15px;
            padding: 3px 15px 3px 15px;
            font-family: 'Open Sans', 'Verdana', 'sans-serif';
            box-shadow:0 2px 5px rgba(0,0,0,0.26);
            background-color: #282c37;
            color: white;
            font-weight: bolder;
            font-size: 15px;
            border: 1px solid black;
        }
        footer {
            clear: both;
            position: fixed; bottom: 0px; height: 50px; background-color: gray; color: white;
            line-height: 50px;
            padding-left: 15px;
            padding-right: 15px;
            display: none;
        }
        h2 {
          font-weight: 900;
          text-transform: uppercase;
          margin: 0;
          position: absolute;
          top: 50%;
          left: 50%;
          font-size: 2rem;
          transform: translate(-50%, -50%);
        }
    </style>
</body>
</html>
